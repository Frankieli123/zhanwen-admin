# 占问管理后台迁移至Art Design Pro实施计划

## 一、迁移策略选择

基于技术架构对比分析，我们选择**渐进式重构方案**：
- 创建新的Vue 3项目基于Art Design Pro
- 保持后端API完全不变
- 逐步迁移前端功能模块
- 最终实现完全替换

## 二、准备工作

### 2.1 环境准备
```bash
# 安装pnpm（Art Design Pro推荐）
npm install -g pnpm

# 克隆Art Design Pro项目
git clone https://github.com/Daymychen/art-design-pro.git zhanwen-admin-vue

# 安装依赖
cd zhanwen-admin-vue
pnpm install
```

### 2.2 后端API文档整理
需要整理的API接口：
- `/api/auth/*` - 认证相关
- `/api/ai-models/*` - AI模型管理
- `/api/prompts/*` - 提示词管理
- `/api/api-keys/*` - API密钥管理
- `/api/configs/*` - 配置管理
- `/api/analytics/*` - 数据分析
- `/api/hexagrams/*` - 卦象管理

### 2.3 数据结构映射

| 当前React组件 | 对应Vue组件 | 数据结构 |
|-------------|-----------|---------|
| Ant Table | el-table | 需转换columns配置 |
| Ant Form | el-form | 需转换rules验证 |
| Ant Modal | el-dialog | 需转换visible控制 |
| Ant Select | el-select | 需转换options格式 |
| Ant DatePicker | el-date-picker | 需转换日期格式 |

## 三、分阶段实施计划

### 第一阶段：基础架构搭建（1-2天）

#### 1. 项目初始化
```typescript
// 1. 修改环境变量配置 (.env.development)
VITE_API_URL=http://localhost:3001
VITE_API_PROXY_URL=http://localhost:3001

// 2. 配置API请求基础路径
// src/utils/request.ts
import axios from 'axios'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
  timeout: 10000
})

// 添加JWT认证
request.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

#### 2. 路由配置
```typescript
// src/router/routes/modules/business.ts
export default {
  path: '/admin',
  name: 'Admin',
  component: () => import('@/layout/index.vue'),
  meta: {
    title: '管理中心',
    icon: 'Setting'
  },
  children: [
    {
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/admin/dashboard/index.vue'),
      meta: { title: '仪表盘' }
    },
    {
      path: 'ai-models',
      name: 'AIModels',
      component: () => import('@/views/admin/ai-models/index.vue'),
      meta: { title: 'AI模型管理' }
    },
    {
      path: 'prompts',
      name: 'Prompts',
      component: () => import('@/views/admin/prompts/index.vue'),
      meta: { title: '提示词管理' }
    },
    {
      path: 'api-keys',
      name: 'ApiKeys',
      component: () => import('@/views/admin/api-keys/index.vue'),
      meta: { title: 'API密钥管理' }
    },
    {
      path: 'configs',
      name: 'Configs',
      component: () => import('@/views/admin/configs/index.vue'),
      meta: { title: '配置管理' }
    },
    {
      path: 'analytics',
      name: 'Analytics',
      component: () => import('@/views/admin/analytics/index.vue'),
      meta: { title: '数据分析' }
    }
  ]
}
```

#### 3. 状态管理配置
```typescript
// src/store/modules/auth.ts
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    token: localStorage.getItem('token') || '',
    user: null
  }),
  
  actions: {
    async login(credentials: LoginForm) {
      const { data } = await request.post('/api/auth/login', credentials)
      this.token = data.token
      localStorage.setItem('token', data.token)
      return data
    },
    
    logout() {
      this.token = ''
      this.user = null
      localStorage.removeItem('token')
      router.push('/login')
    }
  }
})
```

### 第二阶段：核心功能迁移（3-5天）

#### 1. AI模型管理模块
```vue
<!-- src/views/admin/ai-models/index.vue -->
<template>
  <div class="ai-models-container">
    <!-- 搜索栏 -->
    <el-card class="search-card">
      <el-form :inline="true" :model="searchForm">
        <el-form-item label="模型名称">
          <el-input v-model="searchForm.name" placeholder="请输入模型名称" />
        </el-form-item>
        <el-form-item label="服务商">
          <el-select v-model="searchForm.provider">
            <el-option label="全部" value="" />
            <el-option label="OpenAI" value="openai" />
            <el-option label="Anthropic" value="anthropic" />
            <el-option label="讯飞" value="xunfei" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSearch">搜索</el-button>
          <el-button @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <!-- 数据表格 -->
    <el-card class="table-card">
      <template #header>
        <div class="card-header">
          <span>模型列表</span>
          <el-button type="primary" @click="handleAdd">新增模型</el-button>
        </div>
      </template>
      
      <el-table :data="tableData" v-loading="loading">
        <el-table-column prop="id" label="ID" width="80" />
        <el-table-column prop="name" label="模型名称" />
        <el-table-column prop="provider" label="服务商" />
        <el-table-column prop="apiKey" label="API密钥" />
        <el-table-column prop="isActive" label="状态">
          <template #default="{ row }">
            <el-tag :type="row.isActive ? 'success' : 'danger'">
              {{ row.isActive ? '启用' : '禁用' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200">
          <template #default="{ row }">
            <el-button type="primary" size="small" @click="handleEdit(row)">编辑</el-button>
            <el-button type="danger" size="small" @click="handleDelete(row)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <el-pagination
        v-model:current-page="currentPage"
        v-model:page-size="pageSize"
        :total="total"
        @current-change="handlePageChange"
      />
    </el-card>

    <!-- 编辑对话框 -->
    <el-dialog v-model="dialogVisible" :title="dialogTitle">
      <el-form :model="formData" :rules="rules" ref="formRef">
        <el-form-item label="模型名称" prop="name">
          <el-input v-model="formData.name" />
        </el-form-item>
        <el-form-item label="服务商" prop="provider">
          <el-select v-model="formData.provider">
            <el-option label="OpenAI" value="openai" />
            <el-option label="Anthropic" value="anthropic" />
            <el-option label="讯飞" value="xunfei" />
          </el-select>
        </el-form-item>
        <el-form-item label="API密钥" prop="apiKey">
          <el-input v-model="formData.apiKey" type="password" />
        </el-form-item>
        <el-form-item label="配置参数" prop="config">
          <el-input v-model="formData.config" type="textarea" :rows="4" />
        </el-form-item>
        <el-form-item label="启用状态" prop="isActive">
          <el-switch v-model="formData.isActive" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="handleSubmit">确定</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { getAIModels, createAIModel, updateAIModel, deleteAIModel } from '@/api/ai-models'

// 数据定义
const loading = ref(false)
const tableData = ref([])
const total = ref(0)
const currentPage = ref(1)
const pageSize = ref(10)
const dialogVisible = ref(false)
const dialogTitle = ref('')
const formRef = ref()

// 搜索表单
const searchForm = reactive({
  name: '',
  provider: ''
})

// 表单数据
const formData = reactive({
  id: null,
  name: '',
  provider: '',
  apiKey: '',
  config: '',
  isActive: true
})

// 表单验证规则
const rules = {
  name: [{ required: true, message: '请输入模型名称', trigger: 'blur' }],
  provider: [{ required: true, message: '请选择服务商', trigger: 'change' }],
  apiKey: [{ required: true, message: '请输入API密钥', trigger: 'blur' }]
}

// 加载数据
const loadData = async () => {
  loading.value = true
  try {
    const res = await getAIModels({
      page: currentPage.value,
      pageSize: pageSize.value,
      ...searchForm
    })
    tableData.value = res.data.list
    total.value = res.data.total
  } finally {
    loading.value = false
  }
}

// 搜索
const handleSearch = () => {
  currentPage.value = 1
  loadData()
}

// 重置
const handleReset = () => {
  searchForm.name = ''
  searchForm.provider = ''
  handleSearch()
}

// 新增
const handleAdd = () => {
  dialogTitle.value = '新增AI模型'
  Object.assign(formData, {
    id: null,
    name: '',
    provider: '',
    apiKey: '',
    config: '',
    isActive: true
  })
  dialogVisible.value = true
}

// 编辑
const handleEdit = (row: any) => {
  dialogTitle.value = '编辑AI模型'
  Object.assign(formData, row)
  dialogVisible.value = true
}

// 删除
const handleDelete = async (row: any) => {
  await ElMessageBox.confirm('确定删除该模型吗？', '提示', {
    confirmButtonText: '确定',
    cancelButtonText: '取消',
    type: 'warning'
  })
  
  await deleteAIModel(row.id)
  ElMessage.success('删除成功')
  loadData()
}

// 提交表单
const handleSubmit = async () => {
  await formRef.value.validate()
  
  if (formData.id) {
    await updateAIModel(formData.id, formData)
    ElMessage.success('更新成功')
  } else {
    await createAIModel(formData)
    ElMessage.success('创建成功')
  }
  
  dialogVisible.value = false
  loadData()
}

// 分页变化
const handlePageChange = () => {
  loadData()
}

onMounted(() => {
  loadData()
})
</script>
```

#### 2. API接口封装
```typescript
// src/api/ai-models.ts
import request from '@/utils/request'

export interface AIModel {
  id: number
  name: string
  provider: string
  apiKey: string
  config: string
  isActive: boolean
}

export const getAIModels = (params: any) => {
  return request.get('/api/ai-models', { params })
}

export const createAIModel = (data: AIModel) => {
  return request.post('/api/ai-models', data)
}

export const updateAIModel = (id: number, data: AIModel) => {
  return request.put(`/api/ai-models/${id}`, data)
}

export const deleteAIModel = (id: number) => {
  return request.delete(`/api/ai-models/${id}`)
}
```

### 第三阶段：数据分析模块迁移（2-3天）

#### 1. 统计图表组件
```vue
<!-- src/views/admin/analytics/components/UsageChart.vue -->
<template>
  <div class="usage-chart">
    <div ref="chartRef" style="width: 100%; height: 400px;"></div>
  </div>
</template>

<script setup lang="ts">
import * as echarts from 'echarts'
import { ref, onMounted, watch } from 'vue'

const props = defineProps({
  data: {
    type: Array,
    default: () => []
  }
})

const chartRef = ref()
let chartInstance: any = null

const initChart = () => {
  chartInstance = echarts.init(chartRef.value)
  
  const option = {
    title: {
      text: 'API调用统计'
    },
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['调用次数', '成功率']
    },
    xAxis: {
      type: 'category',
      data: props.data.map(item => item.date)
    },
    yAxis: [
      {
        type: 'value',
        name: '调用次数'
      },
      {
        type: 'value',
        name: '成功率(%)',
        max: 100
      }
    ],
    series: [
      {
        name: '调用次数',
        type: 'bar',
        data: props.data.map(item => item.count)
      },
      {
        name: '成功率',
        type: 'line',
        yAxisIndex: 1,
        data: props.data.map(item => item.successRate)
      }
    ]
  }
  
  chartInstance.setOption(option)
}

watch(() => props.data, () => {
  if (chartInstance) {
    initChart()
  }
})

onMounted(() => {
  initChart()
  
  window.addEventListener('resize', () => {
    chartInstance?.resize()
  })
})
</script>
```

### 第四阶段：优化与完善（2-3天）

#### 1. 主题适配
```typescript
// src/utils/theme.ts
export const setupTheme = () => {
  // 从Art Design Pro复用主题切换逻辑
  const theme = localStorage.getItem('theme') || 'light'
  document.documentElement.className = theme
}
```

#### 2. 国际化配置
```typescript
// src/locales/zh-CN/admin.ts
export default {
  aiModels: {
    title: 'AI模型管理',
    add: '新增模型',
    edit: '编辑模型',
    delete: '删除模型',
    name: '模型名称',
    provider: '服务商',
    apiKey: 'API密钥',
    status: '状态',
    active: '启用',
    inactive: '禁用'
  }
}
```

#### 3. 权限控制
```typescript
// src/directives/permission.ts
import type { Directive } from 'vue'

export const permission: Directive = {
  mounted(el, binding) {
    const { value } = binding
    const permissions = useAuthStore().permissions
    
    if (!permissions.includes(value)) {
      el.style.display = 'none'
    }
  }
}
```

## 四、数据迁移方案

### 1. 用户数据迁移
```javascript
// 迁移脚本
const migrateUserData = () => {
  // 从localStorage迁移token
  const token = localStorage.getItem('token')
  if (token) {
    // 保持token不变
  }
  
  // 迁移用户偏好设置
  const preferences = localStorage.getItem('userPreferences')
  if (preferences) {
    const parsed = JSON.parse(preferences)
    // 转换为新格式
    const newPreferences = {
      theme: parsed.theme || 'light',
      language: parsed.language || 'zh-CN',
      sidebarCollapsed: parsed.collapsed || false
    }
    localStorage.setItem('app-preferences', JSON.stringify(newPreferences))
  }
}
```

### 2. 缓存数据处理
```javascript
// 清理旧缓存
const clearOldCache = () => {
  // 清理React Query缓存
  localStorage.removeItem('REACT_QUERY_OFFLINE_CACHE')
  
  // 清理Refine相关缓存
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('refine-')) {
      localStorage.removeItem(key)
    }
  })
}
```

## 五、测试计划

### 1. 功能测试清单

| 模块 | 测试项 | 优先级 | 状态 |
|-----|-------|-------|-----|
| 认证 | 登录功能 | P0 | ⏳ |
| 认证 | Token刷新 | P0 | ⏳ |
| 认证 | 登出功能 | P0 | ⏳ |
| AI模型 | 列表展示 | P0 | ⏳ |
| AI模型 | 新增模型 | P0 | ⏳ |
| AI模型 | 编辑模型 | P0 | ⏳ |
| AI模型 | 删除模型 | P0 | ⏳ |
| API密钥 | 生成密钥 | P0 | ⏳ |
| API密钥 | 密钥管理 | P0 | ⏳ |
| 数据分析 | 图表展示 | P1 | ⏳ |
| 数据分析 | 数据导出 | P1 | ⏳ |

### 2. 性能测试
- 页面加载时间 < 2s
- API响应时间 < 500ms
- 图表渲染时间 < 1s

### 3. 兼容性测试
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

## 六、部署方案

### 1. 构建配置
```bash
# 构建生产版本
pnpm build

# 构建产物位置
dist/
├── assets/
├── index.html
└── favicon.ico
```

### 2. Nginx配置
```nginx
server {
    listen 80;
    server_name admin.zhanwen.com;
    
    root /var/www/zhanwen-admin-vue/dist;
    index index.html;
    
    # Vue Router history模式
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. Docker部署
```dockerfile
# Dockerfile
FROM node:18-alpine as builder
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install
COPY . .
RUN pnpm build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## 七、回滚方案

如果迁移出现严重问题，执行以下回滚步骤：

1. **立即切换**：将Nginx配置指向原React应用
2. **数据恢复**：如有数据结构变更，执行回滚脚本
3. **通知用户**：发布公告说明维护状态
4. **问题修复**：在测试环境修复问题后重新上线

## 八、时间线

| 阶段 | 任务 | 预计时间 | 负责人 |
|-----|-----|---------|-------|
| 第一周 | 基础架构搭建 | 2天 | 前端 |
| 第一周 | 核心功能迁移 | 3天 | 前端 |
| 第二周 | 数据分析模块 | 2天 | 前端 |
| 第二周 | 测试与修复 | 2天 | QA |
| 第二周 | 上线准备 | 1天 | DevOps |

## 九、风险评估

### 主要风险
1. **技术风险**：Vue 3学习曲线
2. **时间风险**：迁移周期可能延长
3. **功能风险**：部分功能可能需要重新设计
4. **数据风险**：数据迁移可能出现问题

### 应对措施
1. 提前进行技术培训
2. 制定详细的迁移计划
3. 保留原系统作为备份
4. 充分的测试覆盖

## 十、成功标准

1. ✅ 所有核心功能正常运行
2. ✅ 性能指标达到预期
3. ✅ 用户体验提升明显
4. ✅ 代码质量提高
5. ✅ 维护成本降低
