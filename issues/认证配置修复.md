# 认证配置修复

## 问题描述

用户反馈在 Coolify 部署完成后，访问 `https://zwam.vryo.de/` 直接进入了仪表盘，而不是先检查登录状态跳转到登录界面。但是 API 端点 `https://zwam.vryo.de/api` 正确返回了需要认证的错误信息。

## 问题分析

通过代码检查发现以下问题：

### 1. 环境变量配置不一致
- `frontend/.env.production` 中设置了 `VITE_API_URL=https://zwam.vryo.de/api`
- 但在多个地方的代码中使用了不同的环境变量名：
  - `authProvider.ts` 中使用 `VITE_API_URL`
  - `api.ts` 中使用 `VITE_API_BASE_URL`
  - `data-provider.ts` 中使用 `VITE_API_URL`

### 2. 重复的认证提供者文件
- 存在两个认证提供者文件：
  - `frontend/src/providers/authProvider.ts` (正在使用)
  - `frontend/src/providers/auth-provider.ts` (未使用的旧文件)
- 同样存在重复的数据提供者文件

### 3. API 路径配置问题
- 生产环境中，API 应该通过相对路径 `/api` 访问
- 但环境变量配置了完整的 URL，可能导致跨域问题

## 解决方案

### 1. 统一环境变量配置
- 统一使用 `VITE_API_URL` 作为环境变量名
- 修正生产环境配置为相对路径 `/api`
- 修正开发环境配置为 `http://localhost:3001/api`

### 2. 清理重复文件
- 删除未使用的 `auth-provider.ts` 文件
- 删除未使用的 `data-provider.ts` 文件

### 3. 修复 API 配置
- 更新所有文件中的环境变量名为 `VITE_API_URL`
- 确保 API 基础 URL 配置正确

## 修复内容

### 文件修改列表

1. **frontend/.env.production**
   ```diff
   - VITE_API_URL=https://zwam.vryo.de/api
   + VITE_API_URL=/api
   ```

2. **frontend/.env**
   ```diff
   - VITE_API_BASE_URL=http://localhost:3001
   + VITE_API_URL=http://localhost:3001/api
   ```

3. **frontend/src/utils/api.ts**
   ```diff
   - const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || (
   + const API_BASE_URL = import.meta.env.VITE_API_URL || (
   -   import.meta.env.MODE === 'production' ? '' : 'http://localhost:3001'
   +   import.meta.env.MODE === 'production' ? '/api' : 'http://localhost:3001/api'
   ```

4. **frontend/src/providers/dataProvider.ts**
   ```diff
   - return import.meta.env.VITE_API_BASE_URL || (
   + return import.meta.env.VITE_API_URL || (
   ```

### 删除的文件
- `frontend/src/providers/auth-provider.ts`
- `frontend/src/providers/data-provider.ts`

## 登录认证路径问题修复

### 新发现的问题
在端口问题解决后，发现登录时出现 401 错误："访问被拒绝，需要认证token"。

### 问题根因
前端登录请求路径错误：
- 前端请求：`/api/auth/login`
- 后端实际路径：`/auth/login`

后端路由配置：
- `/auth` 路由挂载在根路径
- `/api` 路由挂载在 `/api` 路径下

### 修复内容

5. **frontend/src/providers/authProvider.ts**
   ```diff
   - const API_URL = import.meta.env.VITE_API_URL || (
   -   import.meta.env.MODE === 'production' ? '/api' : 'http://localhost:3001/api'
   - );
   - const fetchResponse = await fetch(`${API_URL}/auth/login`, {
   + const API_BASE = import.meta.env.VITE_API_URL || (
   +   import.meta.env.MODE === 'production' ? '' : 'http://localhost:3001'
   + );
   + const fetchResponse = await fetch(`${API_BASE}/auth/login`, {
   ```

6. **frontend/src/utils/api.ts**
   - 创建独立的认证客户端，使用正确的基础路径
   - 认证 API 使用 `/auth` 路径，其他 API 使用 `/api` 路径

## 预期效果

修复后，应用应该能够：
1. 正确区分认证 API（`/auth`）和业务 API（`/api`）的路径
2. 登录功能正常工作，不再出现 401 认证错误
3. 在生产环境中正确使用相对路径访问后端 API
4. 在开发环境中正确使用完整 URL 访问后端 API
5. 认证检查能够正常工作，未登录用户会被重定向到登录页面

## Coolify 环境变量设置

### Nix 部署配置
在 Coolify 的 Nix 部署中，环境变量必须在 `nixpacks.toml` 文件的 `[variables]` 部分设置：

```toml
[variables]
# 基础环境配置
NODE_ENV = "production"
PORT = "3001"

# 前端构建环境变量
VITE_API_URL = "/api"
VITE_APP_TITLE = "占卜应用管理后台"

# 后端配置
JWT_EXPIRES_IN = "7d"
LOG_LEVEL = "info"
CORS_ORIGIN = "https://zwam.vryo.de"

# 注意：敏感信息如 JWT_SECRET, DATABASE_URL 需要在 Coolify 界面中设置
```

### 敏感环境变量
以下敏感变量需要在 Coolify Web 界面中设置：
- `JWT_SECRET`: JWT 签名密钥
- `DATABASE_URL`: 数据库连接字符串

## 测试建议

1. 提交并推送 `nixpacks.toml` 的更改到 Git 仓库
2. 在 Coolify 界面中设置敏感环境变量
3. 触发重新部署
4. 访问 `https://zwam.vryo.de/` 验证是否正确跳转到登录页面
5. 登录后验证是否能正常访问仪表盘
6. 检查浏览器开发者工具中的网络请求，确认 API 调用路径正确
