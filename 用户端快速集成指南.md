# 用户端数据上报 - 快速集成指南

## 5分钟快速集成

### 步骤1: 下载SDK
```bash
# 下载 client-sdk-example.js 到你的项目中
wget https://your-domain.com/client-sdk-example.js
```

### 步骤2: 基础集成
```javascript
// 1. 引入SDK
const { DivinationAPI } = require('./client-sdk-example.js');

// 2. 初始化
const api = new DivinationAPI({
  apiKey: 'your-api-key-here'
});

// 3. 创建追踪器
const tracker = api.createUsageTracker({
  platform: 'web',
  userId: 'user-123'
});
```

### 步骤3: 在AI调用后添加一行代码
```javascript
// 你的现有AI调用代码
const response = await callAIAPI(prompt);

// 添加这一行 - 记录调用数据
tracker.trackApiCall({
  modelId: 1,
  tokensUsed: response.usage.total_tokens,
  cost: 0.003,
  responseTimeMs: 1200,
  status: 'success'
});
```

## 常用场景模板

### 聊天应用
```javascript
async function sendChatMessage(message) {
  const startTime = Date.now();
  
  try {
    const response = await aiAPI.chat(message);
    
    // 记录成功调用
    tracker.trackApiCall({
      modelId: 1,
      tokensUsed: response.tokens,
      responseTimeMs: Date.now() - startTime,
      status: 'success'
    });
    
    return response;
  } catch (error) {
    // 记录失败调用
    tracker.trackApiCall({
      modelId: 1,
      responseTimeMs: Date.now() - startTime,
      status: 'error',
      errorMessage: error.message
    });
    throw error;
  }
}
```

### 占卜应用
```javascript
async function performDivination() {
  // 你的占卜逻辑
  const result = await getDivinationResult();
  
  // 记录卦象使用
  tracker.trackMetric(`hexagram_${result.hexagramId}`, 1);
  tracker.trackMetric('divination_count', 1);
  
  return result;
}
```

### 批量处理应用
```javascript
async function processBatch(items) {
  for (const item of items) {
    await processItem(item);
    
    // 记录处理指标
    tracker.trackMetric('items_processed', 1);
  }
  
  // 批量完成后上报
  await tracker.flush();
}
```

## 重要配置

### 生产环境推荐配置
```javascript
const tracker = api.createUsageTracker({
  platform: 'web',
  batchSize: 20,        // 批量大小
  reportInterval: 60000 // 1分钟自动上报
});
```

### 高频应用配置
```javascript
const tracker = api.createUsageTracker({
  platform: 'web',
  batchSize: 5,         // 小批量快速上报
  reportInterval: 30000 // 30秒上报
});
```

## 必须记住的3件事

1. **不要记录敏感数据** - 只记录技术指标，不记录用户输入内容
2. **确保API Key权限** - 需要`usage:write`权限
3. **应用关闭时清理** - 调用`tracker.destroy()`确保数据上报完成

## 验证集成是否成功

1. 在admin后台查看"数据分析"页面
2. 检查是否有新的使用统计数据
3. 查看模型性能统计是否更新

---

**需要帮助？** 查看完整文档：`用户端数据上报使用文档.md`
